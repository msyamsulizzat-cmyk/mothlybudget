<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal Expenses (25→24, Sync)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#f6f7fb; color:#111; }
    header { padding: 16px; background:#fff; position: sticky; top: 0; border-bottom: 1px solid #e7e7ee; z-index: 10; }
    h1 { margin: 0; font-size: 18px; }
    main { padding: 16px; max-width: 980px; margin: 0 auto; }
    .grid { display: grid; gap: 12px; }
    @media (min-width: 900px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    .card { background:#fff; border:1px solid #e7e7ee; border-radius: 12px; padding: 12px; }
    label { font-size: 12px; color:#444; display:block; margin-bottom: 6px; }
    input, select, textarea, button {
      width: 100%; padding: 10px; border-radius: 10px; border:1px solid #d8d8e3; font-size: 14px; box-sizing: border-box; background:#fff;
    }
    textarea { resize: vertical; min-height: 70px; }
    button { cursor: pointer; border: 0; background:#111; color:#fff; font-weight: 600; }
    button.secondary { background:#eef0f6; color:#111; border:1px solid #d8d8e3; }
    .row { display:flex; gap:8px; align-items: stretch; }
    .row > * { flex:1; }
    .muted { color:#666; font-size: 12px; }
    .kpi { font-size: 22px; font-weight: 800; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    th { color:#444; font-weight: 600; }
    .right { text-align:right; }
    .pill { display:inline-block; padding:4px 8px; border-radius: 999px; font-size: 12px; background:#eef0f6; }
    .danger { background:#ffe7ea; color:#b00020; }
    .ok { background:#e9fff0; color:#0b6b2b; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
<header>
  <h1>Personal Expenses</h1>
  <div class="muted" id="periodLabel"></div>
  <div class="muted" id="syncStatus"></div>
</header>

<main class="grid" style="gap:16px;">
  <section class="grid grid-2">
    <div class="card">
      <div class="muted">Total untuk cycle dipilih (25hb → 24hb)</div>
      <div class="kpi" id="totalThisPeriod">RM 0.00</div>
      <div class="muted" id="countThisPeriod">0 transaksi</div>
      <div class="muted small" style="margin-top:6px;">
        Dashboard ikut billing cycle: 25hb bulan ini hingga 24hb bulan hadapan.
      </div>
    </div>

    <div class="card">
      <div class="muted">Pilih cycle (max 12)</div>
      <select id="periodPicker"></select>

      <div style="margin-top:10px;">
        <label style="display:flex; gap:10px; align-items:center; font-size:13px; color:#111; margin:0;">
          <input type="checkbox" id="toggleExcludeSaving" style="width:auto; transform: scale(1.2);" />
          Exclude “Saving” dari kiraan (total & summary)
        </label>
        <div class="muted">Jika ON: kategori Saving tidak dikira sebagai belanja.</div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="secondary" id="btnRefresh">Refresh</button>
        <button class="secondary" id="btnExport">Export CSV</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        Data sync ke Google Sheet (boleh guna iPhone + laptop).
      </div>
    </div>
  </section>

  <section class="grid grid-2">
    <div class="card">
      <h3 style="margin:0 0 10px 0;">Key In Perbelanjaan</h3>
      <form id="expenseForm" class="grid" style="gap:10px;">
        <div class="row">
          <div>
            <label>Tarikh</label>
            <input type="date" id="date" required />
          </div>
          <div>
            <label>Amaun (RM)</label>
            <input type="number" id="amount" min="0" step="0.01" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Kategori (Fixed)</label>
            <select id="category" required></select>
          </div>
          <div>
            <label>Payment Mode</label>
            <select id="mode" required>
              <option>Cash</option>
              <option>QR Pay</option>
              <option>Credit Card Maybank</option>
              <option>Credit Card RHB</option>
              <option>Credit Card BSN</option>
              <option>SPayLater</option>
            </select>
          </div>
        </div>

        <div>
          <label>Notes (optional)</label>
          <textarea id="notes" placeholder="Contoh: makan tengahari, parking, dll"></textarea>
        </div>

        <button type="submit">Simpan (Sync)</button>
      </form>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px 0;">Ringkasan Payment Mode (Cycle Dipilih)</h3>
      <div id="modeSummary"></div>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 10px 0;">Budget Kategori (Cycle Dipilih)</h3>
    <div class="muted" style="margin-bottom:8px;">Budget diambil dari tab <b>Budgets</b> dalam Google Sheet.</div>
    <div id="categorySummary"></div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 10px 0;">Transaksi (Cycle Dipilih)</h3>
    <div class="muted" style="margin-bottom:8px;">Klik “Padam” untuk delete rekod dari Google Sheet.</div>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Tarikh</th>
            <th>Kategori</th>
            <th>Mode</th>
            <th class="right">Amaun</th>
            <th>Notes</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="txTable"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  // === EDIT 2 VALUE INI SAHAJA ===
  const GAS_URL = "https://script.google.com/macros/s/AKfycby0Y_9LgGZOLciEV9s_7F27JyUA75RFEFsG899sgrH050H3EbldlE1q8oopZz2hpNA/exec";
  const TOKEN   = "IsymatPotpot2302";
  // ===============================

  const fmtRM = (n) => "RM " + (Number(n||0)).toFixed(2);
  const todayISO = () => new Date().toISOString().slice(0,10);

  // Normalize any date coming from Google Sheet into YYYY-MM-DD
  function normalizeDateISO(value) {
    const s = String(value || "").trim();
    if (!s) return "";

    // Already YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

    // ISO datetime (YYYY-MM-DDTHH:mm:ss...)
    if (/^\d{4}-\d{2}-\d{2}T/.test(s)) return s.slice(0, 10);

    // DD/MM/YYYY or D/M/YYYY
    const dmY = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (dmY) {
      const dd = dmY[1].padStart(2, "0");
      const mm = dmY[2].padStart(2, "0");
      const yy = dmY[3];
      return `${yy}-${mm}-${dd}`;
    }

    // Let JS parse other formats
    const dt = new Date(s);
    if (!isNaN(dt.getTime())) return dt.toISOString().slice(0, 10);

    return "";
  }

  const FIXED_CATEGORIES = [
    "Nafkah","TNB","PAIP","Makan","Zakat","Petrol","Saving","Digi","Rumah","Taska",
    "Medical card","Iphone","Prime","Maxis","Hibah","Sofa","Others"
  ];

  const MODES = [
    "Cash","QR Pay","Credit Card Maybank","Credit Card RHB","Credit Card BSN","SPayLater"
  ];

  // ====== PERIOD (25 → 24) + max 12 cycles ======
  function getPeriodForDate(dateISO) {
    const dt = new Date(dateISO + "T00:00:00");
    if (isNaN(dt.getTime())) throw new Error("Invalid Date: " + dateISO);

    const y = dt.getFullYear();
    const m = dt.getMonth(); // 0-11
    const d = dt.getDate();

    let startY = y, startM = m;
    if (d <= 24) {
      const prev = new Date(y, m - 1, 1);
      startY = prev.getFullYear();
      startM = prev.getMonth();
    }

    const start = new Date(startY, startM, 25);
    const end = new Date(startY, startM + 1, 24);

    const toISO = (x) => x.toISOString().slice(0,10);
    return { startISO: toISO(start), endISO: toISO(end), start, end };
  }

  function inPeriod(dateISO, period) {
    if (!dateISO) return false;
    const d = new Date(dateISO + "T00:00:00").getTime();
    if (isNaN(d)) return false;

    const s = new Date(period.startISO + "T00:00:00").getTime();
    const e = new Date(period.endISO + "T23:59:59").getTime();
    return d >= s && d <= e;
  }

  function formatPeriodLabel(period) {
    const opts = { day:"2-digit", month:"short", year:"numeric" };
    const s = period.start.toLocaleDateString("ms-MY", opts);
    const e = period.end.toLocaleDateString("ms-MY", opts);
    return `${s} – ${e}`;
  }

  function periodKey(p){ return `${p.startISO}_${p.endISO}`; }
  // =============================================

  // Elements
  const elPeriodLabel = document.getElementById("periodLabel");
  const elSync = document.getElementById("syncStatus");
  const elTotal = document.getElementById("totalThisPeriod");
  const elCount = document.getElementById("countThisPeriod");
  const elPicker = document.getElementById("periodPicker");

  const elToggleExcludeSaving = document.getElementById("toggleExcludeSaving");

  const elCat = document.getElementById("category");
  const elMode = document.getElementById("mode");
  const elNotes = document.getElementById("notes");
  const elDate = document.getElementById("date");
  const elAmount = document.getElementById("amount");
  const elTx = document.getElementById("txTable");
  const elCategorySummary = document.getElementById("categorySummary");
  const elModeSummary = document.getElementById("modeSummary");

  // UI defaults
  elDate.value = todayISO();
  elCat.innerHTML = FIXED_CATEGORIES.map(c=>`<option>${c}</option>`).join("");

  // Toggle Saving persistence
  const SETTING_KEY = "exclude_saving_v1";
  let excludeSaving = (localStorage.getItem(SETTING_KEY) ?? "true") === "true";
  elToggleExcludeSaving.checked = excludeSaving;
  elToggleExcludeSaving.addEventListener("change", ()=>{
    excludeSaving = elToggleExcludeSaving.checked;
    localStorage.setItem(SETTING_KEY, String(excludeSaving));
    summarize();
  });

  // API (avoid CORS preflight with URLSearchParams)
  async function apiGet(action) {
    const url = `${GAS_URL}?action=${encodeURIComponent(action)}&token=${encodeURIComponent(TOKEN)}`;
    const res = await fetch(url);
    return await res.json();
  }

  async function apiPost(action, data) {
    const body = new URLSearchParams({ action, token: TOKEN, ...data });
    const res = await fetch(GAS_URL, { method: "POST", body });
    return await res.json();
  }

  let expenses = [];
  let budgets = {}; // {category: monthly_budget}
  let currentPeriod = getPeriodForDate(todayISO());

  function setSync(ok, msg){
    const pill = ok ? "pill ok" : "pill danger";
    elSync.innerHTML = `<span class="${pill}">${msg}</span>`;
  }

  function expensesThisPeriod(){
    return expenses
      .filter(x => inPeriod(String(x.date||""), currentPeriod))
      .filter(x => !excludeSaving || String(x.category||"").trim().toLowerCase() !== "saving")
      .sort((a,b)=> (String(a.date) < String(b.date) ? 1 : -1));
  }

  function buildPeriodsFromExpensesMax12() {
    const map = new Map();
    for (const x of expenses) {
      const dateISO = String(x.date||"").trim();
      if (!dateISO) continue;
      const p = getPeriodForDate(dateISO);
      map.set(periodKey(p), p);
    }
    const pNow = getPeriodForDate(todayISO());
    map.set(periodKey(pNow), pNow);

    return Array.from(map.values())
      .sort((a,b)=> b.start - a.start)
      .slice(0, 12);
  }

  function renderPeriodPicker() {
    const periods = buildPeriodsFromExpensesMax12();
    if (!periods.length) periods.push(getPeriodForDate(todayISO()));

    const curKey = periodKey(currentPeriod);
    if (!periods.find(p => periodKey(p) === curKey)) currentPeriod = periods[0];

    elPicker.innerHTML = periods.map(p=>{
      const key = periodKey(p);
      const label = formatPeriodLabel(p);
      const selected = key === periodKey(currentPeriod) ? "selected" : "";
      return `<option value="${key}" ${selected}>${label}</option>`;
    }).join("");

    elPeriodLabel.textContent = "Cycle: " + formatPeriodLabel(currentPeriod);

    elPicker.onchange = () => {
      const [s,e] = elPicker.value.split("_");
      const start = new Date(s + "T00:00:00");
      const end = new Date(e + "T00:00:00");
      currentPeriod = { startISO: s, endISO: e, start, end };
      elPeriodLabel.textContent = "Cycle: " + formatPeriodLabel(currentPeriod);
      summarize();
    };
  }

  function summarize(){
    const tx = expensesThisPeriod();
    const total = tx.reduce((s,x)=> s + Number(x.amount||0), 0);
    elTotal.textContent = fmtRM(total);
    elCount.textContent = `${tx.length} transaksi`;

    // Table
    elTx.innerHTML = tx.map(x => `
      <tr>
        <td>${x.date || ""}</td>
        <td>${x.category || ""}</td>
        <td>${x.mode || ""}</td>
        <td class="right">${fmtRM(x.amount)}</td>
        <td>${x.notes || ""}</td>
        <td class="right"><button class="secondary" data-del="${x.id}">Padam</button></td>
      </tr>
    `).join("");

    // Category summary with budget
    const byCat = {};
    tx.forEach(x => byCat[x.category] = (byCat[x.category]||0) + Number(x.amount||0));

    elCategorySummary.innerHTML = `
      <table>
        <thead><tr><th>Kategori</th><th class="right">Spent</th><th class="right">Budget</th><th class="right">Baki</th></tr></thead>
        <tbody>
          ${FIXED_CATEGORIES.map(c=>{
            const spent = byCat[c]||0;
            const bud = Number(budgets[c]||0);
            const rem = bud - spent;
            const cls = (bud && rem < 0) ? "pill danger" : "pill";
            return `
              <tr>
                <td>${c}</td>
                <td class="right">${fmtRM(spent)}</td>
                <td class="right">${bud ? fmtRM(bud) : '<span class="muted">—</span>'}</td>
                <td class="right">${bud ? `<span class="${cls}">${fmtRM(rem)}</span>` : '<span class="muted">—</span>'}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;

    // Mode summary
    const byMode = {};
    tx.forEach(x => byMode[x.mode] = (byMode[x.mode]||0) + Number(x.amount||0));

    elModeSummary.innerHTML = `
      <table>
        <thead><tr><th>Mode</th><th class="right">Spent</th></tr></thead>
        <tbody>
          ${MODES.map(m=>`
            <tr><td>${m}</td><td class="right">${fmtRM(byMode[m]||0)}</td></tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  async function refreshAll(){
    try{
      setSync(true, "Syncing...");
      const [ex, bd] = await Promise.all([apiGet("listExpenses"), apiGet("listBudgets")]);

      if (!ex.ok) throw new Error(ex.error || "listExpenses failed");
      if (!bd.ok) throw new Error(bd.error || "listBudgets failed");

      expenses = (ex.items || []).map(x => ({
        id: x.id,
        date: normalizeDateISO(x.date),
        category: String(x.category || ""),
        amount: Number(x.amount || 0),
        mode: String(x.mode || ""),
        notes: String(x.notes || "")
      })).filter(x => x.date); // drop rows with invalid date

      budgets = {};
      (bd.items || []).forEach(x => {
        const cat = String(x.category || "").trim();
        if (cat) budgets[cat] = Number(x.monthly_budget || 0);
      });

      currentPeriod = getPeriodForDate(todayISO());
      renderPeriodPicker();

      summarize();
      setSync(true, "Synced ✓");
    }catch(err){
      setSync(false, "Sync error: " + String(err.message || err));
    }
  }

  // Add expense (sync) — send YYYY-MM-DD
  document.getElementById("expenseForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const payload = {
      date: elDate.value,
      category: elCat.value,
      amount: String(Number(elAmount.value||0)),
      mode: elMode.value,
      notes: elNotes.value.trim()
    };
    try{
      setSync(true, "Saving...");
      const res = await apiPost("addExpense", payload);
      if (!res.ok) throw new Error(res.error || "addExpense failed");
      elAmount.value = "";
      elNotes.value = "";
      await refreshAll();
    }catch(err){
      setSync(false, "Save error: " + String(err.message || err));
    }
  });

  // Delete expense (sync)
  document.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-del]");
    if (!btn) return;
    const id = btn.getAttribute("data-del");
    if (!confirm("Padam rekod ini?")) return;

    try{
      setSync(true, "Deleting...");
      const res = await apiPost("deleteExpense", { id });
      if (!res.ok) throw new Error(res.error || "deleteExpense failed");
      await refreshAll();
    }catch(err){
      setSync(false, "Delete error: " + String(err.message || err));
    }
  });

  // Export CSV for selected cycle
  document.getElementById("btnExport").addEventListener("click", ()=>{
    const tx = expensesThisPeriod();
    const rows = [["Date","Category","Amount","Payment Mode","Notes"]]
      .concat(tx.map(x=>[x.date,x.category,x.amount,x.mode,x.notes||""]));
    const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `expenses_${currentPeriod.startISO}_to_${currentPeriod.endISO}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("btnRefresh").addEventListener("click", refreshAll);

  // start
  refreshAll();
</script>
</body>
</html>
